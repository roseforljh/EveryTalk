name: Test Telegram Notification

on:
  workflow_dispatch:

jobs:
  test-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Create Dummy APK
        run: echo "This is a dummy APK content for testing telegram notification." > app-release.apk

      - name: Send Test APK Notification
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_TO }}
          REPO: ${{ github.repository }}
          # 模拟数据
          BRANCH: "main"
          RUN_ID: ${{ github.run_id }}
          SHA: ${{ github.sha }}
          COMMIT_MSG: "feat: implement new telegram notification style with apk file"
        run: |
          python3 -c "
          import os
          import requests

          token = os.environ['TG_TOKEN']
          chat_id = os.environ['TG_CHAT_ID']
          repo = os.environ['REPO']
          branch = os.environ['BRANCH']
          run_id = os.environ['RUN_ID']
          sha = os.environ['SHA']
          commit_msg = os.environ['COMMIT_MSG']

          commit_url = f'https://github.com/{repo}/commit/{sha}'
          run_url = f'https://github.com/{repo}/actions/runs/{run_id}'
          
          caption = f'''<b>EveryTalk</b>
          Branch: {branch}
          #ci_{run_id}

          <blockquote>{commit_msg}</blockquote>

          <a href=\"{commit_url}\">Commit</a>
          <a href=\"{run_url}\">Workflow run</a>'''

          file_path = 'app-release.apk'
          
          print(f'Sending {file_path} to {chat_id}...')
          
          with open(file_path, 'rb') as f:
              files = {'document': f}
              data = {
                  'chat_id': chat_id,
                  'parse_mode': 'HTML',
                  'caption': caption
              }
              response = requests.post(
                  f'https://api.telegram.org/bot{token}/sendDocument',
                  data=data,
                  files=files
              )
              
              print(f'Status Code: {response.status_code}')
              print(f'Response: {response.text}')
              
              if response.status_code != 200:
                  exit(1)
          "