name: Test Telegram Notification

on:
  workflow_dispatch:

jobs:
  test-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Create Dummy APK
        # 确保文件创建在当前工作目录
        run: echo "This is a dummy APK content for testing telegram notification." > ./app-release.apk

      - name: Send Test APK Notification
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_TO }}
          REPO: ${{ github.repository }}
          # 模拟数据
          BRANCH: "main"
          RUN_ID: ${{ github.run_id }}
          SHA: ${{ github.sha }}
          COMMIT_MSG: "feat: implement new telegram notification style with apk file"
        run: |
          # 构造链接
          COMMIT_URL="https://github.com/$REPO/commit/$SHA"
          RUN_URL="https://github.com/$REPO/actions/runs/$RUN_ID"
          
          # 构造 Caption (使用 HTML 格式以支持引用块和超链接)
          # 注意：HTML 标签需要正确闭合
          
          CAPTION="<b>EveryTalk</b>%0A"
          CAPTION+="Branch: $BRANCH%0A"
          CAPTION+="#ci_$RUN_ID%0A%0A"
          CAPTION+="<blockquote>$COMMIT_MSG</blockquote>%0A%0A"
          CAPTION+="<a href=\"$COMMIT_URL\">Commit</a>%0A"
          CAPTION+="<a href=\"$RUN_URL\">Workflow run</a>"

          # 发送文档 (APK)
          # 获取绝对路径
          APK_PATH=$(readlink -f app-release.apk)
          echo "APK absolute path: $APK_PATH"
          ls -la "$APK_PATH"

          curl -v -F chat_id="$TG_CHAT_ID" \
               -F document=@"$APK_PATH" \
               -F parse_mode="HTML" \
               -F caption="$CAPTION" \
               "https://api.telegram.org/bot$TG_TOKEN/sendDocument"