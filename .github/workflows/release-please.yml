name: Release Please

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Sync manifest version from Gradle
        run: |
          python - << 'PY'
          import re, json, pathlib

          gradle_path = pathlib.Path("app1/app/build.gradle.kts")
          text = gradle_path.read_text(encoding="utf-8")
          m = re.search(r'versionName\s*=\s*"([^"]+)"', text)
          if not m:
              raise SystemExit("versionName not found in EveryTalk/app1/app/build.gradle.kts")
          version = m.group(1)

          manifest_path = pathlib.Path(".release-please-manifest.json")
          manifest_path.write_text(
              json.dumps({".": version}, indent=2) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Release Please (manifest)
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.PAT }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
